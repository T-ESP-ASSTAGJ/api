name: Trivy Scan Api

on:
  push:
    branches: [main, staging, TEM-71]
  workflow_dispatch:
  pull_request:
    branches: [main, TEM-71]

jobs:
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_url: ${{ steps.build.outputs.image_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env.local with secrets
        run: |
          echo "APP_SECRET=${{ secrets.APP_SECRET }}" >> .env.local
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.local
          echo "MERCURE_JWT_SECRET=${{ secrets.MERCURE_JWT_SECRET }}" >> .env.local
          echo "MERCURE_URL=https://example.com/.well-known/mercure" >> .env.local
          echo "MERCURE_PUBLIC_URL=https://example.com/.well-known/mercure" >> .env.local
          echo "‚úÖ Created .env.local with GitHub secrets"

      - name: Set image name and hash tag
        id: set-image
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_URL="ghcr.io/${REPO_OWNER}/jamly-api"
          
          # Calcul du hash du Dockerfile + contexte
          CONTEXT_HASH=$(tar -c . | sha256sum | cut -d' ' -f1)
          echo "IMAGE_URL=$IMAGE_URL" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=$CONTEXT_HASH" >> $GITHUB_OUTPUT

      - name: Build and push Docker image if needed
        run: |
          IMAGE_URL=${{ steps.set-image.outputs.IMAGE_URL }}
          IMAGE_TAG=${{ steps.set-image.outputs.IMAGE_TAG }}

          if docker pull $IMAGE_URL:$IMAGE_TAG; then
            echo "Image already exists, skipping build"
          else
            echo "üê≥ Building Docker image..."
            docker build -t $IMAGE_URL:$IMAGE_TAG --target frankenphp_staging .
            echo "üì§ Pushing to GitHub Container Registry..."
            docker push $IMAGE_URL:$IMAGE_TAG
          fi

          # Tag latest pour la branche main
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "üè∑Ô∏è Tagging as latest..."
            docker tag $IMAGE_URL:$IMAGE_TAG $IMAGE_URL:latest
            docker push $IMAGE_URL:latest
          fi

          echo "‚úÖ Image pushed/available at $IMAGE_URL:$IMAGE_TAG"


  security-scan:
    name: Trivy Security Scan
    needs: build-image
    uses: T-ESP-ASSTAGJ/infra/.github/workflows/trivy-scan.yml@TEM-71
    permissions:
      security-events: write
      contents: read
      packages: read
      pull-requests: write
    with:
      image_name: ${{ needs.build-image.outputs.image_url }}
      image_tag: ${{ github.sha }}
    secrets:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      GH_TOKEN: ${{ secrets.GHCR_PAT }}